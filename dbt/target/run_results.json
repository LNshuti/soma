{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.4", "generated_at": "2025-07-15T17:41:44.787223Z", "invocation_id": "7f8f36c3-90a9-47ec-b79e-555a41c99def", "invocation_started_at": "2025-07-15T17:41:42.705813Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.177823Z", "completed_at": "2025-07-15T17:41:43.187151Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.187486Z", "completed_at": "2025-07-15T17:41:43.249071Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0735170841217041, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.ab_test_base", "compiled": true, "compiled_code": "\n\nWITH base AS (\n  SELECT\n    campaign_id,\n    experiment_id,\n    treatment_group,\n    impressions,\n    clicks,\n    spend,\n    CAST(clicks AS FLOAT) / NULLIF(impressions, 0) AS ctr,\n    CAST(spend AS FLOAT) / NULLIF(clicks, 0) AS cpc\n  FROM \"soma\".\"raw\".\"campaign_events\"\n  WHERE experiment_id IS NOT NULL\n)\n\nSELECT * FROM base", "relation_name": "\"soma\".\"main\".\"ab_test_base\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.184116Z", "completed_at": "2025-07-15T17:41:43.200198Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.205554Z", "completed_at": "2025-07-15T17:41:43.250814Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.07466292381286621, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.stg_inventory", "compiled": true, "compiled_code": "\n\nWITH source AS (\n    SELECT * FROM \"soma\".\"raw\".\"inventory\"\n),\n\ncleaned AS (\n    SELECT\n        inventory_id,\n        book_id,\n        warehouse_location,\n        stock_quantity,\n        reorder_point,\n        last_restock_date,\n        storage_cost_per_unit,\n        shelf_life_days,\n        created_at,\n        CASE \n            WHEN stock_quantity <= reorder_point THEN true \n            ELSE false \n        END AS needs_restock,\n        CURRENT_TIMESTAMP AS dbt_updated_at\n    FROM source\n)\n\nSELECT * FROM cleaned", "relation_name": "\"soma\".\"main\".\"stg_inventory\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.185595Z", "completed_at": "2025-07-15T17:41:43.199779Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.202019Z", "completed_at": "2025-07-15T17:41:43.252637Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.07676506042480469, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.stg_publishers", "compiled": true, "compiled_code": "\n\nWITH source AS (\n    SELECT * FROM \"soma\".\"raw\".\"publishers\"\n),\n\ncleaned AS (\n    SELECT\n        publisher_id,\n        publisher_name,\n        publisher_type,\n        country,\n        established_year,\n        total_titles,\n        CASE \n            WHEN active_status = 'Active' THEN true \n            ELSE false \n        END AS is_active,\n        created_at,\n        CURRENT_TIMESTAMP AS dbt_updated_at\n    FROM source\n)\n\nSELECT * FROM cleaned", "relation_name": "\"soma\".\"main\".\"stg_publishers\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.182356Z", "completed_at": "2025-07-15T17:41:43.199998Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.203762Z", "completed_at": "2025-07-15T17:41:43.253515Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.07786703109741211, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.stg_books", "compiled": true, "compiled_code": "\n\nWITH source AS (\n    SELECT * FROM \"soma\".\"raw\".\"books\"\n),\n\ncleaned AS (\n    SELECT\n        book_id,\n        isbn,\n        title,\n        author,\n        publisher_id,\n        genre,\n        publication_year,\n        page_count,\n        price,\n        format,\n        language,\n        created_at,\n        CURRENT_TIMESTAMP AS dbt_updated_at\n    FROM source\n    WHERE page_count > 0 \n      AND price > 0\n)\n\nSELECT * FROM cleaned", "relation_name": "\"soma\".\"main\".\"stg_books\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.259748Z", "completed_at": "2025-07-15T17:41:43.263651Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.265831Z", "completed_at": "2025-07-15T17:41:43.297921Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.040987253189086914, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.ab_test_summary", "compiled": true, "compiled_code": "\n\nWITH base AS (\n  SELECT * FROM \"soma\".\"main\".\"ab_test_base\"\n)\n\nSELECT\n  experiment_id,\n  treatment_group,\n  COUNT(*) AS num_campaigns,\n  AVG(ctr) AS avg_ctr,\n  STDDEV(ctr) AS std_ctr,\n  AVG(cpc) AS avg_cpc,\n  STDDEV(cpc) AS std_cpc\nFROM base\nGROUP BY 1, 2", "relation_name": "\"soma\".\"main\".\"ab_test_summary\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.258149Z", "completed_at": "2025-07-15T17:41:43.263453Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.263896Z", "completed_at": "2025-07-15T17:41:43.299344Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.04283022880554199, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.stg_sales", "compiled": true, "compiled_code": "\n\nWITH source AS (\n    SELECT * FROM \"soma\".\"raw\".\"sales\"\n),\n\ncleaned AS (\n    SELECT\n        transaction_id,\n        book_id,\n        sale_date,\n        quantity,\n        unit_price,\n        discount_percent,\n        total_amount,\n        channel,\n        customer_type,\n        region,\n        created_at,\n        EXTRACT(YEAR FROM sale_date) AS sale_year,\n        EXTRACT(MONTH FROM sale_date) AS sale_month,\n        EXTRACT(DOW FROM sale_date) AS day_of_week,\n        CURRENT_TIMESTAMP AS dbt_updated_at\n    FROM source\n    WHERE quantity > 0 \n      AND unit_price > 0\n      AND total_amount > 0\n)\n\nSELECT * FROM cleaned", "relation_name": "\"soma\".\"main\".\"stg_sales\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.301873Z", "completed_at": "2025-07-15T17:41:43.303560Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.303776Z", "completed_at": "2025-07-15T17:41:43.318765Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.017613887786865234, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.ab_test_lift_analysis", "compiled": true, "compiled_code": "\n\nWITH summary AS (\n  SELECT * FROM \"soma\".\"main\".\"ab_test_summary\"\n),\n\npivoted AS (\n  SELECT\n    s1.experiment_id,\n    s1.avg_ctr AS control_ctr,\n    s2.avg_ctr AS treatment_ctr,\n    s1.avg_cpc AS control_cpc,\n    s2.avg_cpc AS treatment_cpc\n  FROM summary s1\n  JOIN summary s2\n    ON s1.experiment_id = s2.experiment_id\n   AND s1.treatment_group = 'control'\n   AND s2.treatment_group = 'treatment'\n)\n\nSELECT\n  experiment_id,\n  control_ctr,\n  treatment_ctr,\n  COALESCE(treatment_ctr - control_ctr, 0) AS ctr_lift,\n  CASE \n    WHEN control_ctr > 0 \n    THEN 100.0 * (treatment_ctr - control_ctr) / control_ctr \n    ELSE 0 \n  END AS ctr_lift_pct,\n  control_cpc,\n  treatment_cpc,\n  COALESCE(control_cpc - treatment_cpc, 0) AS cpc_reduction,\n  CASE \n    WHEN control_cpc > 0 \n    THEN 100.0 * (control_cpc - treatment_cpc) / control_cpc \n    ELSE 0 \n  END AS cpc_reduction_pct\nFROM pivoted", "relation_name": "\"soma\".\"main\".\"ab_test_lift_analysis\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.262050Z", "completed_at": "2025-07-15T17:41:43.267663Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.267920Z", "completed_at": "2025-07-15T17:41:43.365622Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.1044011116027832, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.dim_publishers", "compiled": true, "compiled_code": "\n\nWITH publishers AS (\n    SELECT * FROM \"soma\".\"main\".\"stg_publishers\"\n),\n\nenriched AS (\n    SELECT\n        publisher_id,\n        publisher_name,\n        publisher_type,\n        country,\n        established_year,\n        total_titles,\n        is_active,\n        CASE \n            WHEN established_year < 1980 THEN 'Legacy'\n            WHEN established_year < 2000 THEN 'Established'\n            ELSE 'Modern'\n        END AS publisher_era,\n        CASE \n            WHEN total_titles > 100 THEN 'Large'\n            WHEN total_titles > 20 THEN 'Medium'\n            ELSE 'Small'\n        END AS publisher_size,\n        created_at,\n        dbt_updated_at\n    FROM publishers\n)\n\nSELECT * FROM enriched", "relation_name": "\"soma\".\"main\".\"dim_publishers\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.367872Z", "completed_at": "2025-07-15T17:41:43.369557Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.369766Z", "completed_at": "2025-07-15T17:41:43.759341Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.39215803146362305, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.dim_books", "compiled": true, "compiled_code": "\n\nWITH books AS (\n    SELECT * FROM \"soma\".\"main\".\"stg_books\"\n),\n\npublishers AS (\n    SELECT * FROM \"soma\".\"main\".\"dim_publishers\"\n),\n\nenriched AS (\n    SELECT\n        b.book_id,\n        b.isbn,\n        b.title,\n        b.author,\n        b.publisher_id,\n        p.publisher_name,\n        p.publisher_type,\n        b.genre,\n        b.publication_year,\n        b.page_count,\n        b.price,\n        b.format,\n        b.language,\n        CASE \n            WHEN b.page_count < 150 THEN 'Short'\n            WHEN b.page_count < 300 THEN 'Medium'\n            WHEN b.page_count < 500 THEN 'Long'\n            ELSE 'Very Long'\n        END AS length_category,\n        CASE \n            WHEN b.price < 15 THEN 'Budget'\n            WHEN b.price < 30 THEN 'Standard'\n            WHEN b.price < 50 THEN 'Premium'\n            ELSE 'Luxury'\n        END AS price_category,\n        CASE \n            WHEN b.publication_year >= 2020 THEN 'Recent'\n            WHEN b.publication_year >= 2015 THEN 'Current'\n            WHEN b.publication_year >= 2010 THEN 'Older'\n            ELSE 'Legacy'\n        END AS recency_category,\n        b.created_at,\n        b.dbt_updated_at\n    FROM books b\n    LEFT JOIN publishers p ON b.publisher_id = p.publisher_id\n)\n\nSELECT * FROM enriched", "relation_name": "\"soma\".\"main\".\"dim_books\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:43.761571Z", "completed_at": "2025-07-15T17:41:43.767198Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:43.767414Z", "completed_at": "2025-07-15T17:41:44.181429Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.421281099319458, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.fact_sales", "compiled": true, "compiled_code": "\n\nWITH sales AS (\n    SELECT * FROM \"soma\".\"main\".\"stg_sales\"\n),\n\nbooks AS (\n    SELECT * FROM \"soma\".\"main\".\"dim_books\"\n),\n\nfinal AS (\n    SELECT\n        s.transaction_id,\n        s.book_id,\n        s.sale_date,\n        s.quantity,\n        s.unit_price,\n        s.discount_percent,\n        s.total_amount,\n        s.channel,\n        s.customer_type,\n        s.region,\n        s.sale_year,\n        s.sale_month,\n        s.day_of_week,\n        b.publisher_id,\n        b.genre,\n        b.format,\n        b.price_category,\n        b.length_category,\n        s.created_at,\n        s.dbt_updated_at\n    FROM sales s\n    LEFT JOIN books b ON s.book_id = b.book_id\n    \n    \n        WHERE s.dbt_updated_at > (SELECT MAX(dbt_updated_at) FROM \"soma\".\"main\".\"fact_sales\")\n    \n)\n\nSELECT * FROM final", "relation_name": "\"soma\".\"main\".\"fact_sales\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:44.193672Z", "completed_at": "2025-07-15T17:41:44.199302Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:44.201403Z", "completed_at": "2025-07-15T17:41:44.286081Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.1004338264465332, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.sales_performance_daily", "compiled": true, "compiled_code": "\n\nWITH daily_sales AS (\n    SELECT\n        sale_date,\n        genre,\n        channel,\n        region,\n        COUNT(*) AS transaction_count,\n        SUM(quantity) AS total_quantity,\n        SUM(total_amount) AS total_revenue,\n        AVG(total_amount) AS avg_transaction_value,\n        AVG(unit_price) AS avg_unit_price,\n        AVG(discount_percent) AS avg_discount_percent\n    FROM \"soma\".\"main\".\"fact_sales\"\n    GROUP BY 1, 2, 3, 4\n),\n\nwith_trends AS (\n    SELECT\n        *,\n        LAG(total_revenue) OVER (\n            PARTITION BY genre, channel, region \n            ORDER BY sale_date\n        ) AS prev_day_revenue,\n        AVG(total_revenue) OVER (\n            PARTITION BY genre, channel, region \n            ORDER BY sale_date \n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS rolling_7day_avg_revenue\n    FROM daily_sales\n)\n\nSELECT\n    *,\n    CASE \n        WHEN prev_day_revenue IS NOT NULL AND prev_day_revenue > 0\n        THEN (total_revenue - prev_day_revenue) / prev_day_revenue * 100 \n        ELSE NULL \n    END AS day_over_day_growth_pct,\n    CASE \n        WHEN rolling_7day_avg_revenue IS NOT NULL AND rolling_7day_avg_revenue > 0\n        THEN (total_revenue - rolling_7day_avg_revenue) / rolling_7day_avg_revenue * 100 \n        ELSE NULL \n    END AS vs_7day_avg_pct\nFROM with_trends", "relation_name": "\"soma\".\"main\".\"sales_performance_daily\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:44.190782Z", "completed_at": "2025-07-15T17:41:44.195572Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:44.197735Z", "completed_at": "2025-07-15T17:41:44.318775Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.13328909873962402, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.inventory_optimization", "compiled": true, "compiled_code": "\n\nWITH inventory AS (\n    SELECT * FROM \"soma\".\"main\".\"stg_inventory\"\n),\n\nsales_velocity AS (\n    SELECT\n        book_id,\n        COUNT(*) AS transaction_count_30d,\n        SUM(quantity) AS units_sold_30d,\n        AVG(quantity) AS avg_quantity_per_transaction\n    FROM \"soma\".\"main\".\"fact_sales\"\n    WHERE sale_date >= CURRENT_DATE - INTERVAL '30 days'\n    GROUP BY book_id\n),\n\nbooks AS (\n    SELECT * FROM \"soma\".\"main\".\"dim_books\"\n),\n\ninventory_analysis AS (\n    SELECT\n        i.inventory_id,\n        i.book_id,\n        b.title,\n        b.genre,\n        b.publisher_name,\n        i.warehouse_location,\n        i.stock_quantity,\n        i.reorder_point,\n        i.needs_restock,\n        i.storage_cost_per_unit,\n        COALESCE(sv.units_sold_30d, 0) AS units_sold_30d,\n        COALESCE(sv.transaction_count_30d, 0) AS transaction_count_30d,\n        CASE \n            WHEN sv.units_sold_30d > 0 \n            THEN i.stock_quantity::FLOAT / (sv.units_sold_30d / 30.0)\n            ELSE NULL \n        END AS days_of_inventory,\n        i.stock_quantity * i.storage_cost_per_unit AS total_storage_cost,\n        CASE \n            WHEN sv.units_sold_30d = 0 THEN 'Dead Stock'\n            WHEN i.stock_quantity::FLOAT / NULLIF(sv.units_sold_30d / 30.0, 0) < 7 THEN 'Fast Moving'\n            WHEN i.stock_quantity::FLOAT / NULLIF(sv.units_sold_30d / 30.0, 0) < 30 THEN 'Normal'\n            WHEN i.stock_quantity::FLOAT / NULLIF(sv.units_sold_30d / 30.0, 0) < 90 THEN 'Slow Moving'\n            ELSE 'Very Slow'\n        END AS velocity_category\n    FROM inventory i\n    LEFT JOIN sales_velocity sv ON i.book_id = sv.book_id\n    LEFT JOIN books b ON i.book_id = b.book_id\n)\n\nSELECT * FROM inventory_analysis", "relation_name": "\"soma\".\"main\".\"inventory_optimization\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:44.188963Z", "completed_at": "2025-07-15T17:41:44.195368Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:44.195970Z", "completed_at": "2025-07-15T17:41:44.359486Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.17421603202819824, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.demand_forecasting_features", "compiled": true, "compiled_code": "\n\nWITH daily_demand AS (\n    SELECT\n        book_id,\n        sale_date,\n        SUM(quantity) AS daily_quantity,\n        SUM(total_amount) AS daily_revenue,\n        COUNT(*) AS daily_transactions\n    FROM \"soma\".\"main\".\"fact_sales\"\n    GROUP BY book_id, sale_date\n),\n\ntime_series_features AS (\n    SELECT\n        book_id,\n        sale_date,\n        daily_quantity,\n        daily_revenue,\n        daily_transactions,\n        \n        -- Date features\n        EXTRACT(YEAR FROM sale_date) AS year,\n        EXTRACT(MONTH FROM sale_date) AS month,\n        EXTRACT(DAY FROM sale_date) AS day,\n        EXTRACT(DOW FROM sale_date) AS day_of_week,\n        EXTRACT(WEEK FROM sale_date) AS week_of_year,\n        EXTRACT(QUARTER FROM sale_date) AS quarter,\n        \n        -- Lag features\n        LAG(daily_quantity, 1) OVER (PARTITION BY book_id ORDER BY sale_date) AS quantity_lag_1,\n        LAG(daily_quantity, 7) OVER (PARTITION BY book_id ORDER BY sale_date) AS quantity_lag_7,\n        LAG(daily_quantity, 30) OVER (PARTITION BY book_id ORDER BY sale_date) AS quantity_lag_30,\n        \n        -- Rolling averages\n        AVG(daily_quantity) OVER (\n            PARTITION BY book_id \n            ORDER BY sale_date \n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS quantity_ma_7,\n        \n        AVG(daily_quantity) OVER (\n            PARTITION BY book_id \n            ORDER BY sale_date \n            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW\n        ) AS quantity_ma_30,\n        \n        -- Rolling standard deviation\n        STDDEV(daily_quantity) OVER (\n            PARTITION BY book_id \n            ORDER BY sale_date \n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS quantity_std_7,\n        \n        -- Growth rates\n        CASE WHEN LAG(daily_quantity, 1) OVER (PARTITION BY book_id ORDER BY sale_date) > 0\n             THEN (daily_quantity - LAG(daily_quantity, 1) OVER (PARTITION BY book_id ORDER BY sale_date)) \n                  / LAG(daily_quantity, 1) OVER (PARTITION BY book_id ORDER BY sale_date) * 100\n             ELSE NULL END AS quantity_growth_rate_1d,\n             \n        CASE WHEN LAG(daily_quantity, 7) OVER (PARTITION BY book_id ORDER BY sale_date) > 0\n             THEN (daily_quantity - LAG(daily_quantity, 7) OVER (PARTITION BY book_id ORDER BY sale_date)) \n                  / LAG(daily_quantity, 7) OVER (PARTITION BY book_id ORDER BY sale_date) * 100\n             ELSE NULL END AS quantity_growth_rate_7d\n             \n    FROM daily_demand\n),\n\nbook_context AS (\n    SELECT * FROM \"soma\".\"main\".\"dim_books\"\n)\n\nSELECT \n    tsf.*,\n    bc.genre,\n    bc.format,\n    bc.price_category,\n    bc.publication_year,\n    CURRENT_TIMESTAMP AS feature_created_at\nFROM time_series_features tsf\nLEFT JOIN book_context bc ON tsf.book_id = bc.book_id", "relation_name": "\"soma\".\"main\".\"demand_forecasting_features\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-07-15T17:41:44.186886Z", "completed_at": "2025-07-15T17:41:44.195765Z"}, {"name": "execute", "started_at": "2025-07-15T17:41:44.199548Z", "completed_at": "2025-07-15T17:41:44.782813Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.5977463722229004, "adapter_response": {"_message": "OK"}, "message": "OK", "failures": null, "unique_id": "model.soma_content_analytics.book_features", "compiled": true, "compiled_code": "\n\nWITH book_sales_metrics AS (\n    SELECT\n        book_id,\n        COUNT(*) AS total_transactions,\n        SUM(quantity) AS total_quantity_sold,\n        SUM(total_amount) AS total_revenue,\n        AVG(total_amount) AS avg_transaction_value,\n        AVG(unit_price) AS avg_selling_price,\n        AVG(discount_percent) AS avg_discount,\n        COUNT(DISTINCT channel) AS num_channels,\n        COUNT(DISTINCT region) AS num_regions,\n        MIN(sale_date) AS first_sale_date,\n        MAX(sale_date) AS last_sale_date\n    FROM \"soma\".\"main\".\"fact_sales\"\n    GROUP BY book_id\n),\n\nrecent_performance AS (\n    SELECT\n        book_id,\n        COUNT(*) AS transactions_last_30d,\n        SUM(quantity) AS quantity_sold_last_30d,\n        SUM(total_amount) AS revenue_last_30d\n    FROM \"soma\".\"main\".\"fact_sales\"\n    WHERE sale_date >= CURRENT_DATE - INTERVAL '30 days'\n    GROUP BY book_id\n),\n\nbooks AS (\n    SELECT * FROM \"soma\".\"main\".\"dim_books\"\n),\n\npublishers AS (\n    SELECT * FROM \"soma\".\"main\".\"dim_publishers\"\n),\n\nml_features AS (\n    SELECT\n        b.book_id,\n        b.isbn,\n        b.title,\n        \n        -- Book attributes\n        b.genre,\n        b.publication_year,\n        b.page_count,\n        b.price,\n        b.format,\n        b.language,\n        b.length_category,\n        b.price_category,\n        b.recency_category,\n        \n        -- Publisher attributes\n        b.publisher_id,\n        p.publisher_type,\n        p.publisher_era,\n        p.publisher_size,\n        \n        -- Sales performance features\n        COALESCE(sm.total_transactions, 0) AS total_transactions,\n        COALESCE(sm.total_quantity_sold, 0) AS total_quantity_sold,\n        COALESCE(sm.total_revenue, 0) AS total_revenue,\n        COALESCE(sm.avg_transaction_value, 0) AS avg_transaction_value,\n        COALESCE(sm.avg_selling_price, b.price) AS avg_selling_price,\n        COALESCE(sm.avg_discount, 0) AS avg_discount,\n        COALESCE(sm.num_channels, 0) AS num_channels,\n        COALESCE(sm.num_regions, 0) AS num_regions,\n        \n        -- Recent performance\n        COALESCE(rp.transactions_last_30d, 0) AS transactions_last_30d,\n        COALESCE(rp.quantity_sold_last_30d, 0) AS quantity_sold_last_30d,\n        COALESCE(rp.revenue_last_30d, 0) AS revenue_last_30d,\n        \n        -- Derived features\n        CASE WHEN sm.total_transactions > 0 \n             THEN sm.total_quantity_sold::FLOAT / sm.total_transactions \n             ELSE 0 END AS avg_quantity_per_transaction,\n             \n        CASE WHEN sm.first_sale_date IS NOT NULL \n             THEN (CURRENT_DATE - sm.first_sale_date)\n             ELSE NULL END AS days_since_first_sale,\n             \n        CASE WHEN sm.last_sale_date IS NOT NULL \n             THEN (CURRENT_DATE - sm.last_sale_date)\n             ELSE NULL END AS days_since_last_sale,\n             \n        -- Velocity score\n        CASE WHEN COALESCE(sm.total_transactions, 0) > 0\n             THEN (COALESCE(rp.transactions_last_30d, 0) * 12.0) / sm.total_transactions\n             ELSE 0 END AS velocity_score,\n             \n        -- Price efficiency\n        CASE WHEN b.page_count > 0 \n             THEN b.price / b.page_count \n             ELSE 0 END AS price_per_page,\n             \n        -- Book age in months\n        (EXTRACT(YEAR FROM CURRENT_DATE) - b.publication_year) * 12 \n        + EXTRACT(MONTH FROM CURRENT_DATE) AS book_age_months,\n        \n        CURRENT_TIMESTAMP AS feature_created_at\n        \n    FROM books b\n    LEFT JOIN publishers p ON b.publisher_id = p.publisher_id\n    LEFT JOIN book_sales_metrics sm ON b.book_id = sm.book_id\n    LEFT JOIN recent_performance rp ON b.book_id = rp.book_id\n)\n\nSELECT * FROM ml_features", "relation_name": "\"soma\".\"main\".\"book_features\"", "batch_results": null}], "elapsed_time": 1.704590082168579, "args": {"defer": false, "exclude": [], "static_parser": true, "validate_macro_args": false, "quiet": false, "indirect_selection": "eager", "show_resource_report": false, "state_modified_compare_more_unrendered_values": false, "introspect": true, "empty": false, "require_batched_execution_for_custom_microbatch_strategy": false, "macro_debugging": false, "print": true, "require_yaml_configuration_for_mf_time_spines": false, "send_anonymous_usage_stats": true, "invocation_command": "dbt run", "which": "run", "log_file_max_bytes": 10485760, "favor_state": false, "log_format": "default", "populate_cache": true, "require_nested_cumulative_type_params": false, "strict_mode": false, "use_fast_test_edges": false, "require_all_warnings_handled_by_warn_error": false, "use_colors": true, "warn_error_options": {"error": [], "warn": [], "silence": []}, "log_format_file": "debug", "profiles_dir": "./dbt", "show_all_deprecations": false, "log_level": "info", "select": [], "state_modified_compare_vars": false, "printer_width": 80, "write_json": true, "source_freshness_run_project_hooks": true, "vars": {}, "require_resource_names_without_spaces": true, "partial_parse": true, "skip_nodes_if_on_run_start_fails": false, "upload_to_artifacts_ingest_api": false, "cache_selected_only": false, "use_colors_file": true, "version_check": true, "project_dir": "./dbt", "partial_parse_file_diff": true, "log_level_file": "debug", "require_explicit_package_overrides_for_builtin_materializations": true, "log_path": "dbt/logs"}}